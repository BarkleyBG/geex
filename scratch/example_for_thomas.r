# this is an example from my dissertation research: the following code was used to obtain the 
# variance estimator for the MOM estimator, ACE(cc)_{MOM}, in Section 1.4.2 of Chapter 1

library(Ryacas)

# parameters are cell counts for the binary variables (z,d_provider,d_subject,y)
# note: since there is no treatment access in the z=0 arm, only 2 cells correspond to z=0
p0000 = Sym("p0000")
p0001 = Sym("p0001")
p1000 = Sym("p1000")
p1001 = Sym("p1001")
p1100 = Sym("p1100")
p1101 = Sym("p1101")
p1110 = Sym("p1110")
p1111 = Sym("p1111")

# define ACE(cc)_{MOM} as a function
ACE = function(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111) {
  return(p1111/(p1110 + p1111) - ((p1000 + p1001) * p0001 * 
    (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - p1001 * 
    (p0000 + p0001) * (p1100 + p1101 + p1000 + p1001))/((p1000 + 
    p1001) * ((p0000 + p0001) * (p1000 + p1001 + p1100 + p1101 + 
    p1110 + p1111) - (p1100 + p1101) * (p0000 + p0001) - (p1000 + 
    p1001) * (p0000 + p0001))))
}

####################################################################################
# compute derivatives
####################################################################################

# partial derivative of ACE(cc)_{MOM} wrt p0000
(d0000_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p0000)))

# the rest of the partial derivatives
(d0001_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p0001)))
(d1000_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p1000)))
(d1001_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p1001)))
(d1100_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p1100)))
(d1101_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p1101)))
(d1110_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p1110)))
(d1111_yacas = yacas(deriv(ACE(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),p1111)))


#############################################################################
### compute variance
#############################################################################

MOM.variance.funt = function(n,p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111)
{
  # partial derivative of ACE(cc)_{MOM} wrt p0000, copied from above
  d0000 = ((p1000 + p1001) * ((p0000 + p0001) * (p1000 + p1001 + 
    p1100 + p1101 + p1110 + p1111) - (p1100 + p1101) * (p0000 + 
    p0001) - (p1000 + p1001) * (p0000 + p0001)) * (p1001 * (p1100 + 
    p1101 + p1000 + p1001)) + ((p1000 + p1001) * p0001 * (p1000 + 
    p1001 + p1100 + p1101 + p1110 + p1111) - p1001 * (p0000 + 
    p0001) * (p1100 + p1101 + p1000 + p1001)) * ((p1000 + p1001) * 
    (p1000 + p1001 + p1100 + p1101 + p1110 + p1111 - (p1100 + 
        p1101) - (p1000 + p1001))))/((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)))^2

  d0001 = -(((p1000 + p1001) * ((p0000 + p0001) * (p1000 + p1001 + 
    p1100 + p1101 + p1110 + p1111) - (p1100 + p1101) * (p0000 + 
    p0001) - (p1000 + p1001) * (p0000 + p0001)) * ((p1000 + p1001) * 
    (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - p1001 * 
    (p1100 + p1101 + p1000 + p1001)) - ((p1000 + p1001) * p0001 * 
    (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - p1001 * 
    (p0000 + p0001) * (p1100 + p1101 + p1000 + p1001)) * ((p1000 + 
    p1001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111 - 
    (p1100 + p1101) - (p1000 + p1001))))/((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)))^2)

  d1000 = -(((p1000 + p1001) * ((p0000 + p0001) * (p1000 + p1001 + 
    p1100 + p1101 + p1110 + p1111) - (p1100 + p1101) * (p0000 + 
    p0001) - (p1000 + p1001) * (p0000 + p0001)) * ((p1000 + p1001) * 
    p0001 + p0001 * (p1000 + p1001 + p1100 + p1101 + p1110 + 
    p1111) - p1001 * (p0000 + p0001)) - ((p1000 + p1001) * p0001 * 
    (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - p1001 * 
    (p0000 + p0001) * (p1100 + p1101 + p1000 + p1001)) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)))/((p1000 + p1001) * ((p0000 + p0001) * (p1000 + p1001 + 
    p1100 + p1101 + p1110 + p1111) - (p1100 + p1101) * (p0000 + 
    p0001) - (p1000 + p1001) * (p0000 + p0001)))^2)
  
  d1001 = -(((p1000 + p1001) * ((p0000 + p0001) * (p1000 + p1001 + 
    p1100 + p1101 + p1110 + p1111) - (p1100 + p1101) * (p0000 + 
    p0001) - (p1000 + p1001) * (p0000 + p0001)) * ((p1000 + p1001) * 
    p0001 + p0001 * (p1000 + p1001 + p1100 + p1101 + p1110 + 
    p1111) - (p1001 * (p0000 + p0001) + (p0000 + p0001) * (p1100 + 
    p1101 + p1000 + p1001))) - ((p1000 + p1001) * p0001 * (p1000 + 
    p1001 + p1100 + p1101 + p1110 + p1111) - p1001 * (p0000 + 
    p0001) * (p1100 + p1101 + p1000 + p1001)) * ((p0000 + p0001) * 
    (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - (p1100 + 
    p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + p0001)))/((p1000 + 
    p1001) * ((p0000 + p0001) * (p1000 + p1001 + p1100 + p1101 + 
    p1110 + p1111) - (p1100 + p1101) * (p0000 + p0001) - (p1000 + 
    p1001) * (p0000 + p0001)))^2)
  
  d1100 = -((p1000 + p1001) * ((p0000 + p0001) * (p1000 + p1001 + 
    p1100 + p1101 + p1110 + p1111) - (p1100 + p1101) * (p0000 + 
    p0001) - (p1000 + p1001) * (p0000 + p0001)) * ((p1000 + p1001) * 
    p0001 - p1001 * (p0000 + p0001))/((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)))^2)
  
  d1101 = -((p1000 + p1001) * ((p0000 + p0001) * (p1000 + p1001 + 
    p1100 + p1101 + p1110 + p1111) - (p1100 + p1101) * (p0000 + 
    p0001) - (p1000 + p1001) * (p0000 + p0001)) * ((p1000 + p1001) * 
    p0001 - p1001 * (p0000 + p0001))/((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)))^2)

  d1110 = -p1111/(p1110 + p1111)^2 - ((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)) * ((p1000 + p1001) * p0001) - ((p1000 + p1001) * 
    p0001 * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    p1001 * (p0000 + p0001) * (p1100 + p1101 + p1000 + p1001)) * 
    ((p1000 + p1001) * (p0000 + p0001)))/((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)))^2
    
  d1111 = p1110/(p1110 + p1111)^2 - ((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)) * ((p1000 + p1001) * p0001) - ((p1000 + p1001) * 
    p0001 * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    p1001 * (p0000 + p0001) * (p1100 + p1101 + p1000 + p1001)) * 
    ((p1000 + p1001) * (p0000 + p0001)))/((p1000 + p1001) * ((p0000 + 
    p0001) * (p1000 + p1001 + p1100 + p1101 + p1110 + p1111) - 
    (p1100 + p1101) * (p0000 + p0001) - (p1000 + p1001) * (p0000 + 
    p0001)))^2

  D = matrix(c(d0000,d0001,d1000,d1001,d1100,d1101,d1110,d1111),nrow=1)

  V = diag(c(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111)) -
    matrix(c(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),ncol=1) %*%
    matrix(c(p0000,p0001,p1000,p1001,p1100,p1101,p1110,p1111),nrow=1)

  return((1/n)*(D %*% V %*% t(D)))

}

# MOM.variance.funt(1000,.45,.05,.15,.0167,.15,.0167,.0166,.15)
